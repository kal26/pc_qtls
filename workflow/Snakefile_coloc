import os 
import sys
import pandas as pd
import numpy as np

from snakemake.utils import Paramspace

# input paths
tissue_id_path = config['tissue_id_path']
covariates_dir = config['covariates_dir']
expression_dir = config['expression_dir']
chr_list_path = config['chr_list_path']
genotype_stem = config['genotype_stem']

# output paths
filtered_expression_output_dir = config['filtered_expression_output_dir']
clusters_dir = config['clusters_dir']
eqtl_output_dir = config['eqtl_output_dir']
pcqtl_output_dir = config['pcqtl_output_dir']
pc_output_dir = config['pc_output_dir']
overlap_output_dir = config['overlap_output_dir']
annotations_output_dir = config['annotations_output_dir']


# coloc paths
coloc_output_dir = config['coloc_output_dir']
gwas_meta = config['gwas_meta']
gtex_meta = config['gtex_meta']
gwas_folder = config['gwas_folder']


# load in all the wildcards
df = pd.read_csv(tissue_id_path, header=0)
tissue_ids = list(df['Tissue'])
print('Running on tissues:{}'.format(tissue_ids))

df = pd.read_csv(chr_list_path, header=0)
chr_list = list(df['chr_id'])

def get_clusters(TISSUE, CHROM):
    outpath = f'{coloc_output_dir}/{TISSUE}/temp/{TISSUE}.{CHROM}.cluster_list.txt'.replace(' ', '')
    return open(outpath).read().strip().split("\n")




#chr_list = ['chr21']
#tissue_ids = ['Lung']

# clusters = []
# chr_zipped = []
# tissue_zipped = []

# for tissue_id in tissue_ids:
#     for chrom in chr_list:
#         this_chr_clusters = get_clusters(tissue_id, chrom)
#         print(f'{len(this_chr_clusters)} on {tissue_id}, {chrom}')
#         clusters.extend(this_chr_clusters)
#         chr_zipped.extend([chrom] * len(this_chr_clusters))
#         tissue_zipped.extend([tissue_id] * len(this_chr_clusters))

# clusters = np.asarray(clusters)
# chr_zipped = np.asarray(chr_zipped)
# tissue_zipped = np.asarray(tissue_zipped)

# paramspace = Paramspace(pd.DataFrame({'CLUSTER':clusters, 'CHROM':chr_zipped, 'TISSUE':tissue_zipped}))


include: 'rules/pcqtl.smk'
include: 'rules/eqtl.smk'
# include: 'rules/annotate.smk'
include: 'rules/coloc.smk'



rule all:
    input:
        gwas_coloc = expand(coloc_output_dir + '{TISSUE}/temp/colocs/{TISSUE}.v8.{CHROM}.gwas_coloc.txt', TISSUE=tissue_ids, CHROM=chr_list)