import os 
import sys
import pandas as pd
import numpy as np

from snakemake.utils import Paramspace

# input paths
tissue_id_path = config['tissue_id_path']
covariates_dir = config['covariates_dir']
expression_dir = config['expression_dir']
chr_list_path = config['chr_list_path']
genotype_stem = config['genotype_stem']

# output paths
filtered_expression_output_dir = config['filtered_expression_output_dir']
clusters_dir = config['clusters_dir']
eqtl_output_dir = config['eqtl_output_dir']
pcqtl_output_dir = config['pcqtl_output_dir']
pc_output_dir = config['pc_output_dir']
overlap_output_dir = config['overlap_output_dir']
annotations_output_dir = config['annotations_output_dir']

# cluster params
max_cluster_size = 50
min_cluster_size = 2
min_corr_cutoff = config['min_corr_cutoff']
percent_corr_cutoff = float(config['percent_corr_cutoff'])
cutoff_type = config['cutoff_type']


# annotation paths
gencode_path = config['gencode_path']
full_abc_path = config['full_abc_path']
abc_match_path = config['abc_match_path']
ctcf_match_path = config['ctcf_match_path']
ctcf_dir = config['ctcf_dir'] 
paralog_path = config['paralog_path']
go_path = config['go_path']
cross_map_path = config['cross_map_path']
tad_path = config['tad_path']


# coloc paths
coloc_output_dir = config['coloc_output_dir']
gwas_meta = config['gwas_meta']
gtex_meta = config['gtex_meta']
gwas_folder = config['gwas_folder']


# load in all the wildcards
df = pd.read_csv(tissue_id_path, header=0)
tissue_ids = list(df['Tissue'])

df = pd.read_csv(chr_list_path, header=0)
chr_list = list(df['chr_id'])

# there are no chr 20 clusters, so this gives and error. For now just don't even try it
# need to define a zipped function os chrs and tissues
#chr_list.remove('chr20')
#chr_list = ['chr22']
tissue_ids = ['Thyroid']

# load in list of tissues and chr ids that were found in that tissue
# def get_tissue_chr_id_pairs(directory):
#     chr_ids = []
#     tissue_ids = []
#     for root, directories, files in os.walk(directory):
#         for file in files:
#             if file.endswith(".parquet"):
#                 tissue_ids.append(file.split('.')[0])
#                 chr_ids.append(file.split('.')[-2])
#     return pd.DataFrame({'chr_id':chr_ids, 'tissue_id':tissue_ids})

# matched_chr_tissue_ids = get_tissue_chr_id_pairs(config['eqtl_output_dir'])




gwas_meta_df = pd.read_csv(gwas_meta, sep='\t', header=0)
gwas_ids = list(gwas_meta_df['Tag'])


print('Running on tissues:{}'.format(tissue_ids))

include: 'rules/pcqtl.smk'
include: 'rules/eqtl.smk'
include: 'rules/clusters.smk'
include: 'rules/coloc.smk'



rule all:
    input:
        colocs = expand(coloc_output_dir + '{TISSUE}/{TISSUE}.v8.{GWAS}.susie_{USE_SUSIE}.gwas_coloc.txt', TISSUE=tissue_ids, GWAS=gwas_ids, USE_SUSIE=["FALSE"])